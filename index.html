
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>非正常生活 << [Idea, Code, Life]</title>
    
    <meta name="author" content="Liu Lantao">
    <meta property="wb:webmaster" content="08beceac65f1ad4f" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    <link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/default.min.css">

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>

  <div class="navbar-wrapper">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">非常规思维研究所</a>
          <ul class="nav">
            <li><a href="/">首页</a></li>
            
            
            


  
    
  
    
      
      	
      	<li><a href="/about_me.html">About ME</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
      	
      	<li><a href="/nerd_urls.html">Nerd URLs</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  




          </ul>
        </div>
      </div>
    </div>
  </div>

    <div class="container">

      <div class="content">
        

<div class='container'>
  <div class='span8'>

  <!-- Pagination links -->
  

  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-09-23 00:00:00 +0800">23 Sep 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/09/23/kernel-uek-3813-upgrade-notes.html" title="UEK R3升级手记" rel="bookmark">UEK R3升级手记</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>UEK是OracleLinux发布的内核版本，对内核增加了更多优化。最近发布了UEK R3。如果需要部署3.x系列内核，可以基于此版本进行测试升级了。</p>

<p>主要的更新内容包括：</p>

<ul>
  <li>基于Linux主线版本3.8.13</li>
  <li>虚拟化相关支持升级</li>
  <li>btrfs升级（UEK R2中基于kernel 3.0，UEK R3基于kernel 3.8）</li>
  <li>DTrace 0.4</li>
  <li>cgroups和LXC更新。lxc-0.9.0-2.0.4同时发布</li>
  <li>XEN改进</li>
  <li>大量的驱动升级，涵盖存储设备、网络设备等</li>
</ul>

<p>重要改进：</p>

<ul>
  <li>ext4支持inode内存储小文件（通过-O inline_data）选项
    mkfs.ext4 -O inline_data device
针对已有的ext4文件系统
    tune2fs -O inline_data device</li>
  <li>XFS日志checksum</li>
  <li>zero huge page以改善现有zero 4-KB page的性能</li>
  <li>NUMA节点下内存分配的自动平衡</li>
  <li>memory control group支持额外的参数
    <ul>
      <li>memory.kmem.failcnt</li>
      <li>memory.kmem.limit_in_bytes</li>
      <li>memory.kmem.max_usage_in_bytes</li>
      <li>memory.kmem.usage_in_bytes</li>
    </ul>
  </li>
  <li>SCSI error-handling超时值可以通过/sys/class/scsi_device/*/device/eh_timeout设置</li>
  <li>通过mmap()的flags或shmget()的shmflg参数可以使用variable-sized huge page</li>
  <li>TCP fast open (TFO)</li>
  <li>watchdog定时器设备/dev/watchdog</li>
</ul>

<p>注意事项</p>

<ul>
  <li>I/O scheduler默认为deadline。RHEL中默认为cfq</li>
</ul>

<p>安装UEK R3。</p>

<p>首先需要安装Oracle仓库。安装oracle仓库的方法参考<code>[](http://public-yum.oracle.com)</code>。或者以root身份执行以下命令</p>

<pre><code>#CentOS 5
cd /etc/yum.repos.d
wget https://public-yum.oracle.com/public-yum-el5.repo

#CentOS 6
cd /etc/yum.repos.d
wget https://public-yum.oracle.com/public-yum-ol6.repo
</code></pre>

<p>由于UEK R3还没有加入到正式版本中，所有需要手工设置使用oracle的beta仓库（目前属于测试阶段，以后可能会更改）</p>

<pre><code>cd /etc/yum.repos.d
wget http://public-yum.oracle.com/beta/public-yum-ol6-beta.repo
sed -i s/enabled=0/enabled=1/g public-yum-ol6-beta.repo 或
cat &gt;/etc/yum.repos.d/public-yum-ol6-beta.repo&lt;&lt;EOF
[ol6_beta]
name=Oracle Linux \$releasever Beta (\$basearch)
baseurl=http://public-yum.oracle.com/repo/BETA/OracleLinux/OL6/uek3/\$basearch/
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-oracle
gpgcheck=0
enabled=1
EOF
</code></pre>

<p>现在可以通过yum来安装uek3：
    yum install -y kernel-uek-3.8.13-13.el6uek</p>

<pre><code>[root@localhost yum.repos.d]# yum install kernel-uek-3.8.13-13.el6uek -y
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.btte.net
 * epel: mirrors.hust.edu.cn
 * extras: mirrors.btte.net
 * updates: mirrors.hust.edu.cn
Setting up Install Process
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package kernel-uek.x86_64 0:3.8.13-13.el6uek will be installed
--&gt; Processing Dependency: kernel-firmware = 3.8.13-13.el6uek for package: kernel-uek-3.8.13-13.el6uek.x86_64
--&gt; Running transaction check
---&gt; Package kernel-uek-firmware.noarch 0:3.8.13-13.el6uek will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

========================================================================================================================
 Package                            Arch                  Version                         Repository               Size
========================================================================================================================
Installing:
 kernel-uek                         x86_64                3.8.13-13.el6uek                ol6_beta                 36 M
Installing for dependencies:
 kernel-uek-firmware                noarch                3.8.13-13.el6uek                ol6_beta                1.6 M

Transaction Summary
========================================================================================================================
Install       2 Package(s)

Total download size: 37 M
Installed size: 151 M
Downloading Packages:
(1/2): kernel-uek-3.8.13-13.el6uek.x86_64.rpm                                                    |  36 MB     02:22     
(2/2): kernel-uek-firmware-3.8.13-13.el6uek.noarch.rpm                                           | 1.6 MB     00:05     
------------------------------------------------------------------------------------------------------------------------
Total                                                                                   256 kB/s |  37 MB     02:29     
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : kernel-uek-firmware-3.8.13-13.el6uek.noarch                                                          1/2 
  Installing : kernel-uek-3.8.13-13.el6uek.x86_64                                                                   2/2 
  Verifying  : kernel-uek-firmware-3.8.13-13.el6uek.noarch                                                          1/2 
  Verifying  : kernel-uek-3.8.13-13.el6uek.x86_64                                                                   2/2 

Installed:
  kernel-uek.x86_64 0:3.8.13-13.el6uek                                                                                  

Dependency Installed:
  kernel-uek-firmware.noarch 0:3.8.13-13.el6uek                                                                         

Complete!
</code></pre>

<p>现在可以在/boot目录下和/etc/grub/menu.lst里看到3.8.13版本的内核项。重启试试。</p>

<pre><code>uname -a
Linux localhost.localdomain 3.8.13-13.el6uek.x86_64 #1 SMP Wed Aug 21 14:28:36 PDT 2013 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>

<p>还可以安装其它工具</p>

<pre><code># yum install dtrace-utils
# yum install lxc
</code></pre>

<p><a href="http://linux.oracle.com/RELEASE-NOTES-UEK3-BETA-en.html">Release Notes</a></p>


          <a href="/Technology/2013/09/23/kernel-uek-3813-upgrade-notes.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#Linux-ref">Linux <span>7</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-09-22 00:00:00 +0800">22 Sep 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/2013/09/22/weekly-parallel-gem-installing-using-bundler.html" title="[Weekly]Parallel gem installing using bundler" rel="bookmark">[Weekly]Parallel gem installing using bundler</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>近期关注：</p>

<h4 id="ruby-21gc">ruby 2.1将对GC进行改进</h4>
<p>matz在baruco上宣布在ruby 2.1中将改进GC功能。这对于大规模部署ruby应用的企业来说，是个好消息。ruby官方版本（MRI）一直被人诟病，其中就包含GC方面的原因。而在此之前，大规模部署一般要借助于REE或者JRuby等第三方实现。</p>

<p>Ruby的内存管理采用copy on write方式，亦即fork出的进程会与父进程共用一部分内存空间，除非对内存有改动。但是ruby进程会单独进行gc，导致不同进程会对共享内容进行扫描及改动，copy on write的效果没有发挥出来。</p>

<p>http://www.infoq.com/news/2013/09/ruby-2-1-gc-revamp</p>

<h4 id="bundlergems">Bundler开始支持并行安装gems</h4>
<p>从bundler~&gt;1.4.0开始，Bundler将可以通过-jN选项来指定并行度，并发安装gems。经本人测试，对于标准的rails应用，初次bundle安装的速度提升接近一倍。</p>

<p>测试过程</p>

<pre><code>rvm gemset delete bundler-j1
rvm gemset delete bundler-j8

rvm gemset use bundler-j1 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j1 &amp;&amp; cd rails-j1 &amp;&amp; time bundle install -j1
rvm gemset use bundler-j8 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j8 &amp;&amp; cd rails-j8 &amp;&amp; time bundle install -j8
</code></pre>

<p>结果(-j1):</p>

<pre><code>➜  ~    rvm gemset use bundler-j1 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j1 &amp;&amp; cd rails-j1 &amp;&amp; time bundle install -j1
Using ruby-head with gemset bundler-j1
Fetching: bundler-1.4.0.pre.2.gem (100%)
Successfully installed bundler-1.4.0.pre.2
Parsing documentation for bundler-1.4.0.pre.2
Installing ri documentation for bundler-1.4.0.pre.2
1 gem installed
Cloning into 'rails-j1'...
remote: Finding bitmap roots...
remote: Counting objects: 383508, done.
remote: Compressing objects: 100% (103485/103485), done.
remote: Total 383508 (delta 277740), reused 382388 (delta 276656)
Receiving objects: 100% (383508/383508), 94.56 MiB | 518 KiB/s, done.
Resolving deltas: 100% (277740/277740), done.
Fetching gem metadata from https://rubygems.org/.........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using rake (10.1.0)
Installing i18n (0.6.5)
Installing json (1.8.0)
Installing minitest (5.0.8)
Installing atomic (1.1.14)
Installing thread_safe (0.1.3)
Installing tzinfo (0.3.37)
Using activesupport (4.1.0.beta) from source at .
Installing rack (1.5.2)
Installing rack-test (0.6.2)
Using actionpack (4.1.0.beta) from source at .
Installing builder (3.1.4)
Using activemodel (4.1.0.beta) from source at .
Installing erubis (2.7.0)
Using actionview (4.1.0.beta) from source at .
Installing mime-types (1.25)
Installing polyglot (0.3.3)
Installing treetop (1.4.15)
Installing mail (2.5.4)
Using actionmailer (4.1.0.beta) from source at .
Installing arel (4.0.0)
Using activerecord (4.1.0.beta) from source at .
Installing bcrypt-ruby (3.1.2)
Installing benchmark-ips (1.2.0)
Using bundler (1.4.0.pre.2)
Installing coffee-script-source (1.6.3)
Installing execjs (2.0.1)
Installing coffee-script (2.2.0)
Installing thor (0.18.1)
Using railties (4.1.0.beta) from source at .
Installing coffee-rails (4.0.0)
Installing dalli (2.6.4)
Installing hike (1.2.3)
Installing jquery-rails (2.2.2)
Installing mustache (0.99.4)
Installing mini_portile (0.5.1)
Installing nokogiri (1.6.0)
Installing kindlerb (0.1.1)
Installing metaclass (0.0.1)
Installing mocha (0.14.0)
Installing multi_json (1.8.0)
Installing mysql (2.9.1)
Installing mysql2 (0.3.13)
Installing pg (0.17.0)
Installing racc (1.4.9)
Installing rack-cache (1.2)
Installing tilt (1.4.1)
Installing sprockets (2.10.0)
Installing sprockets-rails (2.0.0)
Using rails (4.1.0.beta) from source at .
Installing rdoc (3.12.2)
Installing redcarpet (2.2.2)
Installing sdoc (0.3.20)
Installing sqlite3 (1.3.8)
Installing turbolinks (1.3.0)
Installing uglifier (2.2.1)
Installing w3c_validators (1.2)
Installing yajl-ruby (1.1.0)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
Post-install message from rdoc:
Depending on your version of ruby, you may need to install ruby rdoc/ri data:

&lt;= 1.8.6 : unsupported
 = 1.8.7 : gem install rdoc-data; rdoc-data --install
 = 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
bundle install -j1  76.48s user 22.49s system 34% cpu 4:49.31 total
</code></pre>

<p>结果(-j8):</p>

<pre><code>➜  ~    rvm gemset use bundler-j8 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j8 &amp;&amp; cd rails-j8 &amp;&amp; time bundle install -j8
Using ruby-head with gemset bundler-j8
Fetching: bundler-1.4.0.pre.2.gem (100%)
Successfully installed bundler-1.4.0.pre.2
Parsing documentation for bundler-1.4.0.pre.2
Installing ri documentation for bundler-1.4.0.pre.2
1 gem installed
Cloning into 'rails-j8'...
remote: Finding bitmap roots...
remote: Counting objects: 383508, done.
remote: Compressing objects: 100% (103485/103485), done.
remote: Total 383508 (delta 277740), reused 382388 (delta 276656)
Receiving objects: 100% (383508/383508), 94.56 MiB | 489 KiB/s, done.
Resolving deltas: 100% (277740/277740), done.
Fetching gem metadata from https://rubygems.org/.........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Installing builder (3.1.4)
Installing atomic (1.1.14)
Using rake (10.1.0)
Installing minitest (5.0.8)
Installing i18n (0.6.5)
Installing rack (1.5.2)
Installing polyglot (0.3.3)
Using bundler (1.4.0.pre.2)
Installing erubis (2.7.0)
Installing json (1.8.0)
Installing coffee-script-source (1.6.3)
Installing mime-types (1.25)
Installing benchmark-ips (1.2.0)
Installing arel (4.0.0)
Installing tzinfo (0.3.37)
Installing mustache (0.99.4)
Installing mini_portile (0.5.1)
Installing hike (1.2.3)
Installing execjs (2.0.1)
Installing multi_json (1.8.0)
Installing dalli (2.6.4)
Installing metaclass (0.0.1)
Installing bcrypt-ruby (3.1.2)
Installing thor (0.18.1)
Installing racc (1.4.9)
Installing tilt (1.4.1)
Installing mysql2 (0.3.13)
Installing mysql (2.9.1)
Installing thread_safe (0.1.3)
Installing redcarpet (2.2.2)
Installing rack-test (0.6.2)
Installing coffee-script (2.2.0)
Installing sqlite3 (1.3.8)
Installing rdoc (3.12.2)
Installing uglifier (2.2.1)
Installing treetop (1.4.15)
Installing rack-cache (1.2)
Using activesupport (4.1.0.beta) from source at .
Using actionpack (4.1.0.beta) from source at .
Using activemodel (4.1.0.beta) from source at .
Using railties (4.1.0.beta) from source at .
Using actionview (4.1.0.beta) from source at .
Using activerecord (4.1.0.beta) from source at .
Installing sprockets (2.10.0)
Installing yajl-ruby (1.1.0)
Installing mocha (0.14.0)
Installing pg (0.17.0)
Installing coffee-rails (4.0.0)
Installing jquery-rails (2.2.2)
Installing sprockets-rails (2.0.0)
Installing sdoc (0.3.20)
Installing turbolinks (1.3.0)
Installing mail (2.5.4)
Using actionmailer (4.1.0.beta) from source at .
Using rails (4.1.0.beta) from source at .
Installing nokogiri (1.6.0)
Installing kindlerb (0.1.1)
Installing w3c_validators (1.2)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
Post-install message from rdoc:
Depending on your version of ruby, you may need to install ruby rdoc/ri data:

&lt;= 1.8.6 : unsupported
= 1.8.7 : gem install rdoc-data; rdoc-data --install
= 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
bundle install -j8  77.96s user 22.92s system 59% cpu 2:49.20 total
</code></pre>

<p>从结果来看，CPU(user/system)时间变化不大，但是cpu利用率有明显提升，总消耗时间减少近一半。并发加快了总体安装的进程。</p>

<p>http://robots.thoughtbot.com/post/59584648154/parallel-gem-installing-using-bundler?utm_source=rubyweekly&amp;utm_medium=email</p>

          <a href="/2013/09/22/weekly-parallel-gem-installing-using-bundler.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
            </ul>
          </span>
          
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-09-15 00:00:00 +0800">15 Sep 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/2013/09/15/update-net-ssh-kerberos-for-ruby--191.html" title="Ruby-1.9.1之后版本支持kerberos问题的解决思路" rel="bookmark">Ruby-1.9.1之后版本支持kerberos问题的解决思路</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>net-ssh是ruby平台上常用的一个库，用于远程登录服务器。在支持kerberos的系统中，可以使用net-ssh-kerberos这个第三方库来支持实现。
随着近几年Ruby版本由1.8.x系列升级到1.9.x系列以及2.x系列，一系列兼容问题出现。</p>

<p>关于具体原因的分析和部分解决方法如下。</p>

<p>原因分析：
net-ssh-kerberos内部使用DL来调用kerberos库。DL接口是Ruby-1.8.7以及之前版本中用来调用动态链接库的方法，而在Ruby-1.9.1之后这一接口被废弃——对于一门成熟的语言，这一接口改动相对较大，直接导致很多第三方库无法工作，net-ssh-kerberos也包含在内。</p>

<p>临时解决办法是改用基于gssapi包装的net-ssh-krb。gssapi库采用了ffi方式，不受ruby版本升级到1.9.1之后的影响。
具体代码示例：</p>

<p>修改Gemfile
    # Gemfile, add following lines.
    gem &lsquo;net-ssh&rsquo;, :require =&gt; &lsquo;net/ssh&rsquo;</p>

<pre><code># for ruby &lt;~ 1.8.7
# gem 'net-ssh-kerberos', :git =&gt; 'https://github.com/Lax/net-ssh-kerberos.git', :branch =&gt; 'master', :require =&gt; 'net/ssh/kerberos'

# for ruby ~&gt; 1.9.1
gem 'net-ssh-krb', :git =&gt; 'https://github.com/Lax/net-ssh-kerberos.git', :branch =&gt; 'gssapi', :require =&gt; 'net/ssh/kerberos'
</code></pre>

<p>执行</p>

<pre><code>$ bundle install
</code></pre>

<p>程序代码</p>

<pre><code>#!/usr/bin/env ruby
require 'rubygems'
require 'bundler'
Bundler.require

host='10.0.0.1'
username='root'

Net::SSH.start(host, username, {:auth_methods =&gt; ["gssapi-with-mic"]}) do |ssh|
  puts ssh.exec!('hostname')
end
</code></pre>

<p>目前net-ssh-krb的开发版已经能够兼容Linux系统，而MacOSX系统上使用这个库还有一些问题。</p>

<p>项目说明文档：
http://blog.liulantao.com/net-ssh-kerberos/</p>

          <a href="/2013/09/15/update-net-ssh-kerberos-for-ruby--191.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
            </ul>
          </span>
          
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-06-13 00:00:00 +0800">13 Jun 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/06/13/why-can-rsync-rapidly-delete-400000-files.html" title="为什么rsync能够快速删除400000文件？" rel="bookmark">为什么rsync能够快速删除400000文件？</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<h3 id="section">背景</h3>

<p>Quora上一篇文章<a href="http://www.quora.com/File-Systems/How-can-someone-rapidly-delete-400-000-files">★How can someone rapidly delete 400,000 files?</a>提到通过rsync能够快速删除大量文件，之后在<a href="http://web.itivy.com/article-797-1.html">Linux技巧：一次删除一百万个文件的最快方法</a>这篇文章里做了一个详细的评测，对于rm/find/rsync等诸多方法的性能做了对比。</p>

<p>对于出现性能的差异，应该属于预料中的结果。为了验证这个现象，我模拟了Quora原提问的要求，创建了40万个文件，分别用rm和rsync进行删除操作，对syscall做统计。为了简化条件，这写文件全部是空文件（使用包含内容的文件对结果不会造成明显差异，有兴趣可以重试一下）。</p>

<p>统计syscall使用了dtruss工具，这是MacOSX上提供的syscall调试工具，基于DTrace。Linux上可以使用SystemTap来代替。</p>

<h3 id="section-1">验证测试步骤</h3>

<h4 id="section-2">第一步，创建测试文件</h4>

<pre><code>mkdir tmp/; seq 1 400000 | xargs -I{} touch tmp/file_{}
</code></pre>

<p>创建的目录文件大小约为13M。这个大小指的是<em>目录文件</em>，不包含目录中文件，要注意。</p>

<pre><code>$ ls -dl tmp/
drwxr-xr-x  56513 lax  wheel  13062562  6 13 16:18 tmp-test-rsync
</code></pre>

<h4 id="dtrussrm">第二步，使用dtruss执行rm命令测试</h4>

<pre><code>$sudo dtruss -c 'rm -rf tmp-test-rm/'

CALL                                        COUNT
__mac_syscall                                   1
audit_session_self                              1
bsdthread_register                              1
exit                                            1
fstatfs64                                       1
getaudit_addr                                   1
getegid                                         1
rmdir                                           1
shared_region_check_np                          1
thread_selfid                                   1
__sysctl                                        2
close                                           2
close_nocancel                                  2
csops                                           2
getpid                                          2
ioctl                                           2
issetugid                                       2
open                                            2
open_nocancel                                   2
pread                                           2
geteuid                                         3
fchdir                                          4
mprotect                                        8
stat64                                         34
mmap                                           93
munmap                                        184
madvise                                       205
getdirentries64                              2659
lstat64                                    311901
unlink                                     400000
</code></pre>

<h4 id="dtrussrsync">第三步，使用dtruss执行rsync命令测试</h4>

<pre><code>$sudo dtruss -c 'rsync -a --delete empty/ tmp/'

CALL                                        COUNT
__mac_syscall                                   1
__pthread_canceled                              1
audit_session_self                              1
bsdthread_register                              1
exit                                            1
fcntl_nocancel                                  1
fork                                            1
fstatfs64                                       1
getaudit_addr                                   1
getegid                                         1
getrlimit                                       1
getuid                                          1
ioctl                                           1
lstat64                                         1
shared_region_check_np                          1
shm_open                                        1
sigprocmask                                     1
sigreturn                                       1
thread_selfid                                   1
umask                                           1
__sysctl                                        2
chdir                                           2
csops                                           2
getdirentries64                                 2
getpid                                          2
lseek                                           2
pread                                           2
socketpair                                      2
fstat64                                         3
munmap                                          3
open_nocancel                                   3
close                                           4
close_nocancel                                  4
geteuid                                         4
issetugid                                       4
open                                            4
wait4                                           6
read_nocancel                                   7
write                                           7
mprotect                                        8
read                                           10
sigaction                                      10
fcntl                                          11
mmap                                           13
select                                         21
stat64                                         35
</code></pre>

<h3 id="section-3">现象分析</h3>

<ul>
  <li>rm
    <ul>
      <li>rm命令大量调用了lstat64和unlink，可以推测删除每个文件前都从文件系统中做过一次lstat操作。</li>
      <li>lstat64的次数低于文件总数，还有另外的原因，之后会在另一篇文章中说明。</li>
      <li>getdirentries64这个调用比较关键。</li>
      <li>过程：正式删除工作的第一阶段，需要通过getdirentries64调用，分批读取目录（每次大约为4K），在内存中建立rm的文件列表；第二阶段，lstat64确定所有文件的状态；第三阶段，通过unlink执行实际删除。这三个阶段都有比较多的系统调用和文件系统操作。</li>
    </ul>
  </li>
  <li>rsync
    <ul>
      <li>rsync所做的系统调用很少。</li>
      <li>没有针对单个文件做lstat和unlink操作。</li>
      <li>命令执行前期，rsync开启了一片共享内存，通过mmap方式加载目录信息。</li>
      <li>只做目录同步，不需要针对单个文件做unlink。</li>
    </ul>
  </li>
</ul>

<p>另外，在<a href="http://web.itivy.com/article-797-1.html">其他人的评测</a>里，rm的上下文切换比较多，会造成System CPU占用较多——对于文件系统的操作，简单增加并发数并不总能提升操作速度。</p>

<h3 id="section-4">总结</h3>

<p>把文件系统的目录与书籍的目录做类比，rm删除内容时，将目录的每一个条目逐个删除(unlink)，需要循环重复操作很多次；rsync删除内容时，建立好新的空目录，替换掉老目录，基本没开销。</p>

<p>结论：频繁做减法不如直接从头来过。</p>

<p>&mdash;Why can rsync rapidly delete 400,000 files?&mdash; </p>

<p>&mdash;by 刘兰涛(http://blog.liulantao.com)&mdash;</p>

          <a href="/Technology/2013/06/13/why-can-rsync-rapidly-delete-400000-files.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#rsync-ref">rsync <span>1</span></a></li>
     
    	<li><a href="/tags.html#rm-ref">rm <span>1</span></a></li>
     
    	<li><a href="/tags.html#DTrace-ref">DTrace <span>1</span></a></li>
     
    	<li><a href="/tags.html#dtruss-ref">dtruss <span>1</span></a></li>
     
    	<li><a href="/tags.html#SystemTap-ref">SystemTap <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-05-21 00:00:00 +0800">21 May 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/05/21/online-books-for-programmers.html" title="推荐给程序员的在线文档" rel="bookmark">推荐给程序员的在线文档</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<h3 id="statistical-formulas-for-programmershttpwwwevanmillerorgstatistical-formulas-for-programmershtml"><a href="http://www.evanmiller.org/statistical-formulas-for-programmers.html">Statistical Formulas For Programmers</a></h3>

<p><a href="https://github.com/evanmiller">Evan Miller</a>是个多才多艺的程序员，曾经写过<a href="http://www.evanmiller.org/nginx-modules-guide.html">Emiller&rsquo;s Guide to Nginx Module Development</a>和<a href="http://www.evanmiller.org/nginx-modules-guide-advanced.html">Emiller&rsquo;s Advanced Topics In Nginx Module Development</a>。
最近他写了一系列关于数据、统计方面的文章，这篇Statistical Formulas For Programmers是其中的一篇。</p>

<h3 id="modern-gpuhttpnvlabsgithubiomoderngpu"><a href="http://nvlabs.github.io/moderngpu/">Modern GPU</a></h3>
<p>现代GPU编程的设计模式。可以利用这个文档作为入门学习和工作参考。
电子书的源码可以在<a href="https://github.com/NVlabs/moderngpu">github</a>下载。</p>

          <a href="/Technology/2013/05/21/online-books-for-programmers.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-05-20 00:00:00 +0800">20 May 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/05/20/local-root-vulnerability-in-the-kernel.html" title="Linux kernel本地提权漏洞修复" rel="bookmark">Linux kernel本地提权漏洞修复</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>Kernel中爆出一个重大的提权漏洞，kernel-2.6.37以上版本几乎都受到影响。由于Redhat会从高版本内核backport一些特性，因此RHEL6自带的2.6.32内核也受影响，同时CentOS、Oracle等基于RHEL的版本都受影响。</p>

<p>漏洞爆出后，Redhat及时更新了RHEL内核，CentOS等迅速跟进。如果你的服务器上用到这些版本内核，请尽快检查一下。</p>

<ul>
  <li><a href="https://lwn.net/Articles/550678/">Local root vulnerability in the kernel</a></li>
  <li><a href="http://fucksheep.org/~sd/warez/semtex.c">semtex.c</a></li>
</ul>

          <a href="/Technology/2013/05/20/local-root-vulnerability-in-the-kernel.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#Kernel-ref">Kernel <span>1</span></a></li>
     
    	<li><a href="/tags.html#Linux-ref">Linux <span>7</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-05-14 00:00:00 +0800">14 May 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/05/14/awk-sort-keys.html" title="awk统计脚本中的排序方法" rel="bookmark">awk统计脚本中的排序方法</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>最近在使用awk工具进行统计时，经常需要用的哈希来保存临时结果，同时在输出前需要根据哈希的key来进行排序。</p>

<p>以前在awk脚本采取的方式是先通过asorti对key进行一次排序，生成一个排序的key列表，然后遍历这个列表，进行输出操作。这个过程会增加几行代码，同时使得代码的可读性下降，不易理解。</p>

<p>awk在排序这方面的文档是比较缺乏的，在翻阅资料是发现，设置环境变量WHINY_USERS=1，可以使遍历任何哈希时根据key的排序顺序进行。这种方式减少了代码量，不过需要提前设置环境变量。
Hadoop的Streaming方式执行脚本，可以通过添加选项-cmdenv WHINY_USERS=1来传递环境变量。</p>

<p>注：awk中哈希的key默认是字符串类型，排序基于字符串顺序。考虑0,1,12,2,21的顺序。</p>

          <a href="/Technology/2013/05/14/awk-sort-keys.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#awk-ref">awk <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-03-28 00:00:00 +0800">28 Mar 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/2013/03/28/digweb-peercdn-concurrency-x-2.html" title="[阅读] 基于P2P的CDN / Go vs Erlang并发模型" rel="bookmark">[阅读] 基于P2P的CDN / Go vs Erlang并发模型</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<h3 id="peercdnhttppeercdncom"><a href="http://peercdn.com">PeerCDN</a></h3>

<p>利用P2P进行文件分发不是什么新鲜事，但是在Web环境引入P2P仍然有很多挑战。PeerCDN团队正在进行相关技术的研发。该项目期望通过P2P技术为网站提供稳定、便捷、低成本的内容分发方案。</p>

<p>任何支持WebRTC的浏览器可以支持这种技术，这比之前需要安装额外软件的技术是一个显著的进步。网站页面中只需要加入一行javascript代码。</p>

<p>PeerCDN的专注点应该是大文件（视频，音频，图片），而对于海量小文件则可能会力不从心。</p>

<p><a href="http://peercdn.com">PeerCDN</a></p>

<h3 id="solving-the-wrong-problemhttpjoearmsgithubcom20130328solving-the-wrong-problemhtml"><a href="http://joearms.github.com/2013/03/28/solving-the-wrong-problem.html">Solving the wrong problem</a></h3>

<p>漫长的计算机发展史，芯片规模扩展和时钟频率提升是一个主旋律，奠定了摩尔定律的基础。摩尔定律对软件发展的意义在于，大部分串行执行的程序，可以获得越来越短的执行时间。</p>

<p>从2004年开始，芯片的发展有了微妙的变化：芯片规模仍然越来越大，开始增加更多的核心，而同时时钟频率并没有继续提升。这种情况颠覆了对软件开发的一些基本的认识。</p>

<p>有现实的例子为证，当一个单线程的C程序遇到支持多线程的Erlang程序，性能高下不再是底层预言获胜，而是能够利用多核提升效率的一方。</p>

<p><a href="http://joearms.github.com/2013/03/28/solving-the-wrong-problem.html">Joe Armstrong的Solving the wrong problem</a></p>

<h3 id="concurrency-models-go-vs-erlanghttpjoneisenmepost38188396218"><a href="http://joneisen.me/post/38188396218">Concurrency Models: Go vs Erlang</a></h3>

<p>一个新手对比了Go和Erlang这两种支持并发的语言。Go采用goroutine，有共享内存，因此在多核上扩展，通过channel方式传递消息，需要进行手工的错误处理；Erlang采用进程模型，不能共享内存，因此可以做多机扩展，通过mailbox方式传递消息，语言自身支持异常，通过OTP实现各种稳定性部署。</p>

<p><a href="http://joneisen.me/post/38188396218">Concurrency Models: Go vs Erlang</a></p>


          <a href="/2013/03/28/digweb-peercdn-concurrency-x-2.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
            </ul>
          </span>
          
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
  
  
  </div>

  <div class='span3 sidebar'>

    <section>
  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=0&speed=0&skin=5&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1653644220&verifier=a57ab42b&dpc=1"></iframe>
<section>

<section>
  <img width='160px' height='160px' src="/images/public/qrcode_for_gh_9329e4243e67_258.jpg" />
</section>

<section>
  <iframe width="300" height="100" src="http://www.taobao.com/go/rgn/union/aliyun_ecs.php?size=300x100&pid=mm_46308197_0_0" frameborder="0" marginheight="0" marginwidth="0" border="0" scrolling="no" name="alimamaifrm"></iframe>
</section>

<section>
	<ul>
		<li><a href='http://mib.cc/cloud.html'>云导航</li>
	</ul>
</section>


    <section>
  <h1>归档</h1>
  <ul id="archive_posts">
  
    
    
    
      <li><a href="/archive.html#archive_2013">2013</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2012">2012</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2011">2011</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2010">2010</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2009">2009</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2008">2008</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2007">2007</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2006">2006</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2005">2005</a></li>
    
  
    
    
    
      <li><a href="/archive.html#archive_2004">2004</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2003">2003</a></li>
    
  
    
    
    
  
    
    
    
  
  </ul>
  <a href="/atom.xml"><i class="icon-star"></i>RSS</a>
</section>


  </div>
</div>

      </div>

      <footer>
        <p>&copy; Liu Lantao 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  <script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

