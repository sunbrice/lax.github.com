
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>[Weekly]Parallel gem installing using bundler</title>
    <meta name="description" content="">
    <meta name="author" content="Liu Lantao">
    <meta property="wb:webmaster" content="08beceac65f1ad4f" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    <link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/default.min.css">

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>

  <div class="navbar-wrapper">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">非常规思维研究所</a>
          <ul class="nav">
            <li><a href="/">首页</a></li>
            
            
            


  
    
  
    
      
      	
      	<li><a href="/about_me.html">About ME</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
      	
      	<li><a href="/nerd_urls.html">Nerd URLs</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  




          </ul>
        </div>
      </div>
    </div>
  </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>[Weekly]Parallel gem installing using bundler </h1>
</div>

<div class="row">
  <div class="span8">
    
<p>近期关注：</p>

<h4 id="ruby-21gc">ruby 2.1将对GC进行改进</h4>
<p>matz在baruco上宣布在ruby 2.1中将改进GC功能。这对于大规模部署ruby应用的企业来说，是个好消息。ruby官方版本（MRI）一直被人诟病，其中就包含GC方面的原因。而在此之前，大规模部署一般要借助于REE或者JRuby等第三方实现。</p>

<p>Ruby的内存管理采用copy on write方式，亦即fork出的进程会与父进程共用一部分内存空间，除非对内存有改动。但是ruby进程会单独进行gc，导致不同进程会对共享内容进行扫描及改动，copy on write的效果没有发挥出来。</p>

<p>http://www.infoq.com/news/2013/09/ruby-2-1-gc-revamp</p>

<h4 id="bundlergems">Bundler开始支持并行安装gems</h4>
<p>从bundler~&gt;1.4.0开始，Bundler将可以通过-jN选项来指定并行度，并发安装gems。经本人测试，对于标准的rails应用，初次bundle安装的速度提升接近一倍。</p>

<p>测试过程</p>

<pre><code>rvm gemset delete bundler-j1
rvm gemset delete bundler-j8

rvm gemset use bundler-j1 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j1 &amp;&amp; cd rails-j1 &amp;&amp; time bundle install -j1
rvm gemset use bundler-j8 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j8 &amp;&amp; cd rails-j8 &amp;&amp; time bundle install -j8
</code></pre>

<p>结果(-j1):</p>

<pre><code>➜  ~    rvm gemset use bundler-j1 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j1 &amp;&amp; cd rails-j1 &amp;&amp; time bundle install -j1
Using ruby-head with gemset bundler-j1
Fetching: bundler-1.4.0.pre.2.gem (100%)
Successfully installed bundler-1.4.0.pre.2
Parsing documentation for bundler-1.4.0.pre.2
Installing ri documentation for bundler-1.4.0.pre.2
1 gem installed
Cloning into 'rails-j1'...
remote: Finding bitmap roots...
remote: Counting objects: 383508, done.
remote: Compressing objects: 100% (103485/103485), done.
remote: Total 383508 (delta 277740), reused 382388 (delta 276656)
Receiving objects: 100% (383508/383508), 94.56 MiB | 518 KiB/s, done.
Resolving deltas: 100% (277740/277740), done.
Fetching gem metadata from https://rubygems.org/.........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Using rake (10.1.0)
Installing i18n (0.6.5)
Installing json (1.8.0)
Installing minitest (5.0.8)
Installing atomic (1.1.14)
Installing thread_safe (0.1.3)
Installing tzinfo (0.3.37)
Using activesupport (4.1.0.beta) from source at .
Installing rack (1.5.2)
Installing rack-test (0.6.2)
Using actionpack (4.1.0.beta) from source at .
Installing builder (3.1.4)
Using activemodel (4.1.0.beta) from source at .
Installing erubis (2.7.0)
Using actionview (4.1.0.beta) from source at .
Installing mime-types (1.25)
Installing polyglot (0.3.3)
Installing treetop (1.4.15)
Installing mail (2.5.4)
Using actionmailer (4.1.0.beta) from source at .
Installing arel (4.0.0)
Using activerecord (4.1.0.beta) from source at .
Installing bcrypt-ruby (3.1.2)
Installing benchmark-ips (1.2.0)
Using bundler (1.4.0.pre.2)
Installing coffee-script-source (1.6.3)
Installing execjs (2.0.1)
Installing coffee-script (2.2.0)
Installing thor (0.18.1)
Using railties (4.1.0.beta) from source at .
Installing coffee-rails (4.0.0)
Installing dalli (2.6.4)
Installing hike (1.2.3)
Installing jquery-rails (2.2.2)
Installing mustache (0.99.4)
Installing mini_portile (0.5.1)
Installing nokogiri (1.6.0)
Installing kindlerb (0.1.1)
Installing metaclass (0.0.1)
Installing mocha (0.14.0)
Installing multi_json (1.8.0)
Installing mysql (2.9.1)
Installing mysql2 (0.3.13)
Installing pg (0.17.0)
Installing racc (1.4.9)
Installing rack-cache (1.2)
Installing tilt (1.4.1)
Installing sprockets (2.10.0)
Installing sprockets-rails (2.0.0)
Using rails (4.1.0.beta) from source at .
Installing rdoc (3.12.2)
Installing redcarpet (2.2.2)
Installing sdoc (0.3.20)
Installing sqlite3 (1.3.8)
Installing turbolinks (1.3.0)
Installing uglifier (2.2.1)
Installing w3c_validators (1.2)
Installing yajl-ruby (1.1.0)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
Post-install message from rdoc:
Depending on your version of ruby, you may need to install ruby rdoc/ri data:

&lt;= 1.8.6 : unsupported
 = 1.8.7 : gem install rdoc-data; rdoc-data --install
 = 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
bundle install -j1  76.48s user 22.49s system 34% cpu 4:49.31 total
</code></pre>

<p>结果(-j8):</p>

<pre><code>➜  ~    rvm gemset use bundler-j8 --create &amp;&amp; gem install bundler --pre &amp;&amp; cd /tmp/ &amp;&amp; git clone https://github.com/rails/rails.git rails-j8 &amp;&amp; cd rails-j8 &amp;&amp; time bundle install -j8
Using ruby-head with gemset bundler-j8
Fetching: bundler-1.4.0.pre.2.gem (100%)
Successfully installed bundler-1.4.0.pre.2
Parsing documentation for bundler-1.4.0.pre.2
Installing ri documentation for bundler-1.4.0.pre.2
1 gem installed
Cloning into 'rails-j8'...
remote: Finding bitmap roots...
remote: Counting objects: 383508, done.
remote: Compressing objects: 100% (103485/103485), done.
remote: Total 383508 (delta 277740), reused 382388 (delta 276656)
Receiving objects: 100% (383508/383508), 94.56 MiB | 489 KiB/s, done.
Resolving deltas: 100% (277740/277740), done.
Fetching gem metadata from https://rubygems.org/.........
Fetching gem metadata from https://rubygems.org/..
Resolving dependencies...
Installing builder (3.1.4)
Installing atomic (1.1.14)
Using rake (10.1.0)
Installing minitest (5.0.8)
Installing i18n (0.6.5)
Installing rack (1.5.2)
Installing polyglot (0.3.3)
Using bundler (1.4.0.pre.2)
Installing erubis (2.7.0)
Installing json (1.8.0)
Installing coffee-script-source (1.6.3)
Installing mime-types (1.25)
Installing benchmark-ips (1.2.0)
Installing arel (4.0.0)
Installing tzinfo (0.3.37)
Installing mustache (0.99.4)
Installing mini_portile (0.5.1)
Installing hike (1.2.3)
Installing execjs (2.0.1)
Installing multi_json (1.8.0)
Installing dalli (2.6.4)
Installing metaclass (0.0.1)
Installing bcrypt-ruby (3.1.2)
Installing thor (0.18.1)
Installing racc (1.4.9)
Installing tilt (1.4.1)
Installing mysql2 (0.3.13)
Installing mysql (2.9.1)
Installing thread_safe (0.1.3)
Installing redcarpet (2.2.2)
Installing rack-test (0.6.2)
Installing coffee-script (2.2.0)
Installing sqlite3 (1.3.8)
Installing rdoc (3.12.2)
Installing uglifier (2.2.1)
Installing treetop (1.4.15)
Installing rack-cache (1.2)
Using activesupport (4.1.0.beta) from source at .
Using actionpack (4.1.0.beta) from source at .
Using activemodel (4.1.0.beta) from source at .
Using railties (4.1.0.beta) from source at .
Using actionview (4.1.0.beta) from source at .
Using activerecord (4.1.0.beta) from source at .
Installing sprockets (2.10.0)
Installing yajl-ruby (1.1.0)
Installing mocha (0.14.0)
Installing pg (0.17.0)
Installing coffee-rails (4.0.0)
Installing jquery-rails (2.2.2)
Installing sprockets-rails (2.0.0)
Installing sdoc (0.3.20)
Installing turbolinks (1.3.0)
Installing mail (2.5.4)
Using actionmailer (4.1.0.beta) from source at .
Using rails (4.1.0.beta) from source at .
Installing nokogiri (1.6.0)
Installing kindlerb (0.1.1)
Installing w3c_validators (1.2)
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
Post-install message from rdoc:
Depending on your version of ruby, you may need to install ruby rdoc/ri data:

&lt;= 1.8.6 : unsupported
= 1.8.7 : gem install rdoc-data; rdoc-data --install
= 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
bundle install -j8  77.96s user 22.92s system 59% cpu 2:49.20 total
</code></pre>

<p>从结果来看，CPU(user/system)时间变化不大，但是cpu利用率有明显提升，总消耗时间减少近一半。并发加快了总体安装的进程。</p>

<p>http://robots.thoughtbot.com/post/59584648154/parallel-gem-installing-using-bundler?utm_source=rubyweekly&amp;utm_medium=email</p>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2013/09/15/update-net-ssh-kerberos-for-ruby--191.html" title="Ruby-1.9.1之后版本支持kerberos问题的解决思路">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/Technology/2013/09/23/kernel-uek-3813-upgrade-notes.html" title="UEK R3升级手记">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>22 September 2013</span></div>

    
  </div>
  <hr />
  

</div>



      </div>

      <footer>
        <p>&copy; Liu Lantao 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  <script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

