
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>非正常生活 << [Idea, Code, Life]</title>
    
    <meta name="author" content="Liu Lantao">
    <meta property="wb:webmaster" content="08beceac65f1ad4f" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    <link rel="stylesheet" href="http://yandex.st/highlightjs/7.3/styles/default.min.css">

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>

  <div class="navbar-wrapper">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">非常规思维研究所</a>
          <ul class="nav">
            <li><a href="/">首页</a></li>
            
            
            


  
    
  
    
      
      	
      	<li><a href="/about_me.html">About ME</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
      	
      	<li><a href="/nerd_urls.html">Nerd URLs</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  




          </ul>
        </div>
      </div>
    </div>
  </div>

    <div class="container">

      <div class="content">
        

<div class='container'>
  <div class='span8'>

  <!-- Pagination links -->
  

  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-01-25 00:00:00 +0800">25 Jan 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/01/25/build-page-with-haml.html" title="使用HAML构建WEB页面" rel="bookmark">使用HAML构建WEB页面</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p><img src="http://haml.info/images/img-hero-boat.png" alt="" />  </p>

<h2 id="section">前言</h2>

<p>在日常系统运维工作中，经常需要为各种系统构建页面，提炼常用的操作放到<strong><em>仪表盘</em></strong>，以提高日常工作效率。</p>

<p>在WEB逻辑层的选择，Ruby中有便捷优雅的Sinatra，Perl中有Dancer，Python有web.py。</p>

<p>页面展现层的开发主要考虑两个方面  </p>

<ol>
  <li>
    <p>构建页面框架</p>

    <p>这个方面考虑构建页面的快速和可重复性。如果仍停留在手工写html页面的阶段，那就太落伍啦。</p>

    <p>常用的方案是基于模版生成HTML代码。PHP本身就是一种模版。</p>

    <p>另外还有ERB，Markdown等轻量级的标记语言，由于Markdown对于语法变量支持不容易集成到动态页面，因此主要用于静态页面构建。</p>
  </li>
  <li>
    <p>页面样式和交互管理</p>

    <p>jQuery无疑是交互管理的首选。如果有较多的数据图表展现，可以选用DDD等框架。</p>

    <p>页面样式方面，可以参考<a href="http://jqueryui.com">jQuery UI</a>, <a href="http://yuilibrary.com">YUI</a>。</p>

    <p>从易用的角度，jQuery结合<a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>是个好选择。</p>
  </li>
</ol>

<p>本文主要介绍其中<code>构建页面框架</code>的方案选择，即用HAML替代ERB。  </p>

<h2 id="hamlerb">haml与erb的对比</h2>

<p><a href="http://haml.info">HAML</a> 是一种简单的html模版语言。它的最大特点是短小精干整洁。  </p>

<p>在HAML项目首页有一项简单的对比，在此引用一下</p>

<p>使用ERB生成的页面代码</p>

<pre><code>&lt;section class=”container”&gt;
  &lt;h1&gt;&lt;%= post.title %&gt;&lt;/h1&gt;
  &lt;h2&gt;&lt;%= post.subtitle %&gt;&lt;/h2&gt;
  &lt;div class=”content”&gt;
    &lt;%= post.content %&gt;
  &lt;/div&gt;
&lt;/section&gt;
</code></pre>

<p>使用HAML生成的页面代码</p>

<pre><code>%section.container
  %h1= post.title
  %h2= post.subtitle
  .content
    = post.content
</code></pre>

<p>通过对比可以看出一些特点</p>

<table>
  <thead>
    <tr>
      <th><strong>对比项目</strong></th>
      <th><strong>ERB</strong></th>
      <th style="text-align: right"><strong>HAML</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>代码行数</td>
      <td>7</td>
      <td style="text-align: right">5</td>
    </tr>
    <tr>
      <td>关闭标签</td>
      <td>需要关闭</td>
      <td style="text-align: right">不需要关闭</td>
    </tr>
    <tr>
      <td>逻辑层级</td>
      <td>与ruby语法相同</td>
      <td style="text-align: right">按空格缩进</td>
    </tr>
    <tr>
      <td>变量</td>
      <td>ruby变量</td>
      <td style="text-align: right">ruby变量</td>
    </tr>
  </tbody>
</table>

<p>其中haml<strong>不需要关闭</strong>和<strong>按空格缩进</strong>两项特性，与Python的风格有几分相似（ruby代码中满屏end的现象，一直受到诟病。python用强迫症式的方案解决了这个问题）——HTML也需要关闭标签。</p>

<h2 id="section-1">实际项目中的应用</h2>

<p>以下示例以HAML构建了一个简单的导航页面</p>

<h3 id="haml">示例haml文件</h3>

<pre><code>-# coding: UTF-8
!!!
%html(xml:lang='zh-cn' lang='zh-cn' xmlns='http://www.w3.org/1999/xhtml')
  %head
    %meta(content='text/html;charset=UTF-8' http-equiv='content-type')
    %link{:href =&gt; "/css/bootstrap.min.css", :rel =&gt;"stylesheet", :type =&gt; "text/css", :media =&gt; "screen" }
  %body
    .container
      %h1 支持系统
      %ul.inline
        %li
          %a.btn{:href =&gt; '#'} Wiki
        %li
          %a.btn{:href =&gt; '#'} Tracker
        %li
          %a.btn{:href =&gt; '/ganglia'} Ganglia
        %li
          %a.btn{:href =&gt; '/nagios/'} Nagios

      %h3 查询
      %form{:action =&gt; "/tools/?", :method =&gt; "GET", :name =&gt; "dnsinfo_form"}
        %input#suggest_dns{:type =&gt; "text", :size =&gt; 25, :name =&gt; "q", :onmouseover =&gt; "this.focus()", :onfocus =&gt; "this.select()", :title =&gt; "关键字: 域名、IP、域名列表或IP列表(,号或空格分隔)", :autocomplete =&gt; "off", :class =&gt; "ac_input"}
        %input{:type =&gt; "submit", :value =&gt; "查询"}
</code></pre>

<h3 id="html">示例html文件</h3>

<p>使用haml命令生成文件</p>

<pre><code>haml index.haml &gt; index.html
</code></pre>

<p>文件内容</p>

<pre><code>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html lang='zh-cn' xml:lang='zh-cn' xmlns='http://www.w3.org/1999/xhtml'&gt;
  &lt;head&gt;
    &lt;meta content='text/html;charset=UTF-8' http-equiv='content-type' /&gt;
    &lt;link href='/css/bootstrap.min.css' media='screen' rel='stylesheet' type='text/css' /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class='container'&gt;
      &lt;h1&gt;支持系统&lt;/h1&gt;
      &lt;ul class='inline'&gt;
        &lt;li&gt;
          &lt;a class='btn' href='#'&gt;Wiki&lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;
          &lt;a class='btn' href='#'&gt;Tracker&lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;
          &lt;a class='btn' href='/ganglia'&gt;Ganglia&lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;
          &lt;a class='btn' href='/nagios/'&gt;Nagios&lt;/a&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
      &lt;h3&gt;查询&lt;/h3&gt;
      &lt;form action='/tools/?' method='GET' name='dnsinfo_form'&gt;
        &lt;input autocomplete='off' class='ac_input' id='suggest_dns' name='q' onfocus='this.select()' onmouseover='this.focus()' size='25' title='关键字: 域名、IP、域名列表或IP列表(,号或空格分隔)' type='text' /&gt;
        &lt;input type='submit' value='查询' /&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

          <a href="/Technology/2013/01/25/build-page-with-haml.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-01-20 00:00:00 +0800">20 Jan 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/2013/01/20/view-documents-on-github-pages-the-ugly-way.html" title="查看github pages中文档的方式" rel="bookmark">查看github pages中文档的方式</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<h2 id="section">背景</h2>

<p>由于<a href="https://github.com/iccfish/12306_ticket_helper/issues/16">抢票插件事件</a>，近期github pages不能正常访问。作为一个普通码农，严重依赖部署在github的项目，这些项目也几乎都以github pages提供文档。缺乏文档确实很不方便，各地的有证与无证码农们已经在weibo等渠道表达不满。</p>

<p>抱怨归抱怨，仍然要想办法看到这些文档，为周末生活找点儿乐趣——<strong>尤其今天这雪后的雾霾天气</strong>。</p>

<h2 id="section-1">方法</h2>

<p>Github pages使用的是一套基于Jekyll的模版系统，原则上只要把各项目的文档源码checkout到本地，重新生成一遍即可。幸运的是这些项目仍可以访问。</p>

<p>以bootstrap库为例来说明一下。</p>

<p>首先获取代码到本地</p>

<pre><code>git clone git://github.com/twitter/bootstrap.git
</code></pre>

<p>进入代码目录，切换到gh-pages分支</p>

<pre><code>cd bootstrap
git checkout gh-pages
</code></pre>

<p>启动jekyll本地服务器</p>

<pre><code>jekyll --server
</code></pre>

<p>在浏览器查看</p>

<pre><code>open http://127.0.0.1:4000
</code></pre>

<p>jekyll是一个ruby工具，你需要先安装ruby和rubygems。</p>

<p>安装RVM:</p>

<pre><code>curl -L https://get.rvm.io | bash -s stable
</code></pre>

<p>安装Jekyll:</p>

<pre><code>gem install jekyll
</code></pre>

          <a href="/2013/01/20/view-documents-on-github-pages-the-ugly-way.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#github-ref">github <span>1</span></a></li>
     
    	<li><a href="/tags.html#rvm-ref">rvm <span>3</span></a></li>
     
    	<li><a href="/tags.html#jekyll-ref">jekyll <span>2</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-01-18 00:00:00 +0800">18 Jan 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2013/01/18/funny-opensource-projects.html" title="有趣的开源项目（一）：Octpress/ktap" rel="bookmark">有趣的开源项目（一）：Octpress/ktap</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<ul id="markdown-toc">
  <li><a href="#octopresshttpsgithubcomimathisoctopress"><a href="https://github.com/imathis/octopress">Octopress</a></a></li>
  <li><a href="#ktaphttpsgithubcomktapktap"><a href="https://github.com/ktap/ktap">ktap</a></a></li>
</ul>

<h1 id="octopresshttpsgithubcomimathisoctopress"><a href="https://github.com/imathis/octopress">Octopress</a></h1>

<p>这是又一个基于jekyll的博客程序，类似Jekyll-Bootstrap。和JB相比，默认界面风格更有传统blog系统的韵味，对于代码的支持也宣称做的更好，实在是众多码农码神的利器。</p>

<p>Octopress is Jekyll blogging at its finest.</p>

<ul>
  <li>Octopress sports a clean responsive theme written in semantic HTML5, focused on readability and friendliness toward mobile devices.</li>
  <li>Code blogging is easy and beautiful. Embed code (with Solarized styling) in your posts from gists, jsFiddle or from your filesystem.</li>
  <li>Third party integration is simple with built-in support for Twitter, Pinboard, Delicious, GitHub Repositories, Disqus Comments and Google Analytics.</li>
  <li>It&rsquo;s easy to use. A collection of rake tasks simplifies development and makes deploying a cinch.</li>
  <li>Ships with great plug-ins some original and others from the Jekyll community — tested and improved.</li>
</ul>

<h1 id="ktaphttpsgithubcomktapktap"><a href="https://github.com/ktap/ktap">ktap</a></h1>

<p>与DTrace、SystemTap类似的追踪程序，用于对系统和程序的调用栈进行追踪调试。目前这个软件还在开发的初始阶段。</p>


          <a href="/Technology/2013/01/18/funny-opensource-projects.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#ktap-ref">ktap <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2013-01-12 00:00:00 +0800">12 Jan 2013</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/2013/01/12/weibo-update-20130107-20130113.html" title="微博更新记录 20130107-20130113" rel="bookmark">微博更新记录 20130107-20130113</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>本周内核方面值得关注的两个改进：mempressure cgroup（内存用尽之前，内核通知应用程序释放内存http://t.cn/zjB4Ahc）和zswap（内存用尽发生后，swap i/o有一层内存缓冲，减少实际磁盘操作 http://t.cn/zjB4AhV）
1月11日15:54來自未通过审核应用</p>

<p>不能赞成更多啦 //@Laruence 其实学Linux Shell, 最最重要的就是领会: &ldquo;各司其职, 协同合作, 解决问题. &ldquo; , 所谓各司其职, 就是学习那些最最基本不过的命令, 他们都很简单, 好像不能解决你的实际问题. 所谓协同合作, 就是理解&rdquo;|&rdquo;的设计, 每一个工具只要关注自己的部分,组合起来却威力无穷. 这个也是软件设计的一个基本思想.
1月10日10:34來自新浪微博</p>

<p>看京剧，发现能看懂剧情了。记得年轻时去看戏从来不关心戏台上老生的咿咿呀呀，满心思都是旁边的小玩具小人书和小零食，偶尔跑到后台凑热闹。。。#爱藕丝#
1月8日22:09來自未通过审核应用</p>

<p>继Android、Ubuntu之后，Open webOS也运行在了Google Nexus 7上，在其它项目的基础上，Simon &ldquo;morphis&rdquo; Busch用一周时间完成。N7成为近期各家基于Linux的操作系统社区的宠儿http://t.cn/zjmvlTu #爱藕丝#
1月7日10:27來自未通过审核应用</p>

          <a href="/2013/01/12/weibo-update-20130107-20130113.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
            </ul>
          </span>
          
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2012-12-30 00:00:00 +0800">30 Dec 2012</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2012/12/30/raspberry-pi-launches-pi-store.html" title="Raspberry Pi上的AppStrore：Pi Store" rel="bookmark">Raspberry Pi上的AppStrore：Pi Store</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>Raspberry Pi项目目标是为教育领域提供一个廉价的硬件平台。</p>

<p>最近Pi项目发布了Pi Store应用商店，目标是让开发者更方便与社区分享游戏，应用，工具和文档。Pi商店是运行在X界面上的一个图形程序。</p>

<p><img src="http://www.raspberrypi.org/wp-content/uploads/2012/12/PiStore-Screen04-300x294.png" /></p>

<p>Pi Store项目希望通过鼓励开发者提交程序来增加应用数量。对于用户推荐，商店管理者则会利用用户对已有应用的评价来推测用户喜好，进行个性推荐。</p>

<p>安装
    sudo apt-get update &amp;&amp; sudo apt-get install pistore</p>

<ul>
  <li>http://www.raspberrypi.org/archives/2768</li>
  <li>https://www.linux.com/news/embedded-mobile/mobile-linux/682440-raspberry-pi-gets-its-own-app-store</li>
</ul>

          <a href="/Technology/2012/12/30/raspberry-pi-launches-pi-store.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#Pi-ref">Pi <span>1</span></a></li>
     
    	<li><a href="/tags.html#Raspberry Pi-ref">Raspberry Pi <span>1</span></a></li>
     
    	<li><a href="/tags.html#Pi Store-ref">Pi Store <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2012-12-28 00:00:00 +0800">28 Dec 2012</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/2012/12/28/gerrit-review-system---setup-notes.html" title="Gerrit Review System - Setup notes" rel="bookmark">Gerrit Review System - Setup notes</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<ul id="markdown-toc">
  <li><a href="#gerrit">Gerrit背景</a></li>
  <li><a href="#section">协作流程简介</a></li>
  <li><a href="#gerrit-1">自定义Gerrit安装</a></li>
  <li><a href="#section-1">创建新项目</a></li>
  <li><a href="#gerrit-2">应用gerrit进行代码管理</a></li>
  <li><a href="#section-2">常见问题处理</a>    <ul>
      <li><a href="#forge-committer-identity">Forge Committer Identity</a></li>
    </ul>
  </li>
</ul>

<h2 id="gerrit">Gerrit背景</h2>

<p>Android作为移动平台上兴起的大型开源操作系统项目，管理大量代码提交者的代码是个复杂的工程。我们来看一下Android项目使用的协作平台Gerrit。</p>

<p>Gerrit是Andriod工程中发展起来的源代码review工具，基于<a href="http://www.kernel.org/pub/software/scm/git/">git</a>，利用了git的branch和merge机制。已经有很多著名的开源项目在使用这个工具来协调代码提交流程，比如Eclipse，CloudFoundry，OpenStack，LibreOffice等开源项目。</p>

<h2 id="section">协作流程简介</h2>
<p>在Gerrit的流程中，代码提交经过以下步骤</p>

<ul>
  <li>Push ：代码提交</li>
  <li>Code Review ： 看代码，确定是否合理</li>
  <li>Verify ： 应用代码，确认是否能正确执行</li>
  <li>Submit Patch ： 与已发布版本合并，成功后合并到master分支</li>
  <li>Rollback ：以上每个步骤都可能失败，并进行相应的流程回退</li>
</ul>

<p>从Android项目的代码提交流程图，可以看到开发者提供一个patch的生命周期。虽然看起来有些复杂，但是这些步骤都在一个web界面中完成。</p>

<p><img src="http://source.android.com/images/workflow-0.png" /></p>

<h2 id="gerrit-1">自定义Gerrit安装</h2>

<p>可喜的是我们能够应该gerrit在自有的管理流程中，按照文档可快速把gerrit搭建起来。gerrit源码中自带的安装文档中有详细的安装过程和注意事项<a href="http://code.google.com/p/gerrit/source/browse/Documentation/install.txt">Documentation/install.txt</a></p>

<p>身份验证方面，默认支持使用OpenID，HTTP或者LDAP验证。对于其它需要比如Kerberos，需要进行一些特殊调整，这在文档中还没有完整说明。</p>

<p>比如在Kerberos方式身份验证部署时，部署httpd作为反向代理，同时采用httpd内置的kerberos模块进行身份验证。配置httpd可以将kerberos登录后的username通过一个http头传给后端的gerrit服务器，实现免密码登陆。关于httpd的配置可以参考<a href="http://www.mailinglistarchive.com/html/repo-discuss@googlegroups.com/2012-01/msg00168.html">这个文档</a>。注意需要配置keytab文件，以及传递用户名的Header名。</p>

<p>数据库选择方面，默认使用内置的H2快速搭建。对于希望长期使用并扩展的系统，应该选择MySQL或PostgreSQL。安装文档中有详细操作说明。</p>

<p>从<a href="http://code.google.com/p/gerrit/downloads/list">google code</a>下载最新版本war包，安装java环境，根据提示设置数据库。身份验证方式选择HTTP（与上文提到Kerberos有关，根据情况可选择OpenID和LDAP等）。</p>

<p>配置反向代理时，登陆页面/login/会跳转到/login/null#null并死循环。在配置文件gerrit.config设置canonicalWebUrl选项可以解决。</p>

<pre><code>[gerrit]
	canonicalWebUrl = http://&lt;address of httpd&gt;/review/
</code></pre>

<p>邮件功能可以选择关闭，在gerrit.config将sendemail设置enabled=false即可关闭。关闭后不能使用邮件功能，包括用户注册的确认邮件。</p>

<pre><code>[sendemail]
	enabled = false
</code></pre>

<p>代码提交步骤依赖用户注册时填写的email地址。关闭sendemail功能时，需要在数据库中直接修改accounts中用户的preferred_email字段。</p>

<h2 id="section-1">创建新项目</h2>

<p>在Gerrit页面上Projects项目下，可以创建项目。安装后默认已有一个叫做All Projects的项目，新项目默认继承这个项目的属性。</p>

<h2 id="gerrit-2">应用gerrit进行代码管理</h2>

<p>gerrit服务端部署成功后，客户端的部署相对简单很多。推荐使用gerrit-cli工具。</p>

<p>gerrit-cli安装方法：</p>

<pre><code>yum install ruby rubygems -y
gem install gerrit-cli
</code></pre>

<p>安装完毕后即可使用gerrit命令。</p>

<pre><code>cd /tmp/
gerrit clone ssh://&lt;username&gt;@&lt;ip address&gt;:29418/&lt;repo name&gt;.git
# cd repo dir &amp;&amp; make changes
git commit -a
gerrit push
</code></pre>

<p>执行push命令成功后，即可在gerrit页面上看到提交的代码开始了review流程。</p>

<h2 id="section-2">常见问题处理</h2>

<h3 id="forge-committer-identity">Forge Committer Identity</h3>

<p>使用gerrit push命令提交修改时，如果提交历史中有其它人的commit（mirror项目代码时一般是这种情况），会提示email不一致。设置Forge Committer Identity权限可以解决。</p>

<p>操作方法：Projects -&gt; List -&gt; All-Projects -&gt; Access，打开权限编辑页面，点Edit按钮。
在Reference: refs/*部分，Add Permission -&gt; Forge Commiter Identity，Allow -&gt; Registered Users。保存后即可正常提交。</p>


          <a href="/Technology/2012/12/28/gerrit-review-system---setup-notes.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#Gerrit-ref">Gerrit <span>1</span></a></li>
     
    	<li><a href="/tags.html#Git-ref">Git <span>2</span></a></li>
     
    	<li><a href="/tags.html#Code Review-ref">Code Review <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2012-10-22 00:00:00 +0800">22 Oct 2012</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/Linux/2012/10/22/squid-ulimit-n.html" title="ulimit -n的重要性" rel="bookmark">ulimit -n的重要性</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<p>最近发现有几个squid实例的稳定性成问题，对比了环境设置，分析了几个可能的因素。</p>

<p>1    由于squid前使用了nginx，为了减少连接开销，开启了keepalive连接。keepalive机制存在一些问题，如客户端不停止发送请求，nginx不会中止与后端服务的连接，这将造成squid的访问压力无法在短时间内调整。不过分析了这个情形，问题不全在这里。</p>

<p>2    发现连接数的最高值稳定在2000左右。看到这个数字，寻思会不会与连接数限制有关。曾经遇到过memcached由于默认1024个连接数用完而不提供服务的现象，吞吐率在瞬间降低为0。由于squid与nginx跑在同一台服务器上，2k恰好约对应squid的1024个连接数。</p>

<p>基于假设2，查看了squid进程的limits。</p>

<p>[root@BJCER210-63 ~]# cat /proc/17174/limits 
 Limit                     Soft Limit           Hard Limit           Units   <br />
 Max cpu time              unlimited            unlimited            seconds <br />
 Max file size             unlimited            unlimited            bytes   <br />
 Max data size             unlimited            unlimited            bytes   <br />
 Max stack size            8388608              unlimited            bytes   <br />
 Max core file size        0                    unlimited            bytes   <br />
 Max resident set          unlimited            unlimited            bytes   <br />
 Max processes             128577               128577               processes 
 Max open files            1024                 4096                 files   <br />
 Max locked memory         65536                65536                bytes   <br />
 Max address space         unlimited            unlimited            bytes   <br />
 Max file locks            unlimited            unlimited            locks   <br />
 Max pending signals       128577               128577               signals <br />
 Max msgqueue size         819200               819200               bytes   <br />
 Max nice priority         0                    0                  <br />
 Max realtime priority     0                    0                  <br />
 Max realtime timeout      unlimited            unlimited            us        </p>

<p>果然Max open files只有默认的1024。查看另外一台更稳定的squid服务器，发现这个值都是65535。</p>

<p>于是准备了一个测试环境，验证了squid启动时设置ulimit -n的重要性：squid后端使用nginx做源并使用nginx-delay设置延时5s，squid进程启动前不设置ulimit及设置为65535，增加并发数，查看各自的表现。</p>

<ul>
  <li>ulimit -n为系统默认1024时，并发数达到800左右吞吐量下降到接近零；</li>
  <li>设置ulimit -n 65535时，并发数增加吞吐量亦增加。</li>
</ul>

<p>假设得到证明，可以推断后端性能变差时，由于可用文件数用完而无法开启新的连接。ulimit -n需要设置足够大才能保证squid的稳定。</p>

          <a href="/Technology/Linux/2012/10/22/squid-ulimit-n.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
              <li><a href="/categories.html#Linux-ref" title="Linux" rel="category tag">Linux</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#ulimit-ref">ulimit <span>1</span></a></li>
     
    	<li><a href="/tags.html#squid-ref">squid <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
    <div class="full">
      <span class="date full-date">
        <abbr class="published" title="2012-09-14 00:00:00 +0800">14 Sep 2012</abbr>
      </span>
      <h3 class="entry-title">
        <a href="/Technology/Linux/2012/09/14/edac.html" title="EDAC" rel="bookmark">EDAC</a>
      </h3>
      <p class="alt-font tight">
        <span>
          
        </span>
      </p>
      <div class="row">
        <div class="span8 entry-content full-content" style='background-color: #FFF; padding: 10px;'>
          
<h1 id="edac-overview">EDAC Overview</h1>
<p>EDAC (Error Detection and Correction) is a set of Linux kernel modules for handling hardware-related errors. </p>

<p>Its major focus has been ECC memory error handling, however it also detects and reports PCI bus parity errors. </p>

<p>EDAC通过sysfs方式获得硬件的信息。检测到问题时，在syslog中可以看到这样的日志：</p>

<pre><code>kernel: EDAC MC1: CE row 0, channel 0, label "": Corrected error (Socket=1 channel=0 dimm=0)
</code></pre>

<p>有一个叫做edac-util的工具，可以用来查看更详细的状态报表。</p>

<pre><code>$ edac-util -r
mc1: csrow0: ch0: 43722040 Corrected Errors
</code></pre>

<p>上面的输出表示有较多的可修复错误（Corrected Errors - CE）被发现。</p>

<p>edac-util的安装，在RHEL或CentOS上，可以通过yum安装：</p>

<pre><code>yum install edac-util -y
</code></pre>

<h1 id="links">Links</h1>

<p>[http://www.kernel.org/doc/Documentation/edac.txt EDAC - Error Detection And Correction]</p>

<p>[http://bluesmoke.sourceforge.net EDAC Project]</p>

          <a href="/Technology/Linux/2012/09/14/edac.html" class="read_more span2 pull-right">[ Read More ]</a>
          <div class="clear"></div>
        </div>
        <div class="span3">
          
          <span>
            Posted in&nbsp;
            <ul>
            
              <li><a href="/categories.html#Technology-ref" title="Technology" rel="category tag">Technology</a></li>
            
              <li><a href="/categories.html#Linux-ref" title="Linux" rel="category tag">Linux</a></li>
            
            </ul>
          </span>
          
          
            <h4>Tags</h4>
            <ul class="tag_box">
            
            


  
     
    	<li><a href="/tags.html#EDAC-ref">EDAC <span>1</span></a></li>
    
  



            </ul>
           
        </div>
      </div>
      <div class="clear"></div>
    </div>
    <div class="rule"><hr/></div>
  
  
  
  </div>

  <div class='span3 sidebar'>

    <section>
  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=0&speed=0&skin=5&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1653644220&verifier=a57ab42b&dpc=1"></iframe>
<section>

<section>
  <img width='160px' height='160px' src="/images/public/qrcode_for_gh_9329e4243e67_258.jpg" />
</section>

<section>
  <iframe width="300" height="100" src="http://www.taobao.com/go/rgn/union/aliyun_ecs.php?size=300x100&pid=mm_46308197_0_0" frameborder="0" marginheight="0" marginwidth="0" border="0" scrolling="no" name="alimamaifrm"></iframe>
</section>

<section>
	<ul>
		<li><a href='http://mib.cc/cloud.html'>云导航</li>
	</ul>
</section>


    <section>
  <h1>归档</h1>
  <ul id="archive_posts">
  
    
    
    
      <li><a href="/archive.html#archive_2013">2013</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2012">2012</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2011">2011</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2010">2010</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2009">2009</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2008">2008</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2007">2007</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2006">2006</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2005">2005</a></li>
    
  
    
    
    
      <li><a href="/archive.html#archive_2004">2004</a></li>
    
  
    
    
    
  
    
    
    
  
    
    
    
      <li><a href="/archive.html#archive_2003">2003</a></li>
    
  
    
    
    
  
    
    
    
  
  </ul>
  <a href="/atom.xml"><i class="icon-star"></i>RSS</a>
</section>


  </div>
</div>

      </div>

      <footer>
        <p>&copy; Liu Lantao 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  <script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

